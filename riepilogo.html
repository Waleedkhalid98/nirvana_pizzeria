<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordine</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .form-container {
            max-width: 500px;
            margin: auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            color: #000;
        }
        .buttons {
            margin-top: 20px;
        }
        .form-control.is-invalid {
            border-color: red;
        }
        * {
    color: #000 !important;
}
/* Sovrascrivi il colore del testo e del background per i textarea con la classe form-control */
.form-group textarea.form-control, select.form-control {
    color: #000 !important;
    background-color: #fff !important;
}

/* Anche i placeholder del textarea */
textarea.form-control::placeholder, select.form-control::placeholder {
    color: #000 !important;
    opacity: 1;
}


input.form-control, textarea.form-control, select.form-control {
    border: 1px solid #000 !important; /* Forza il bordo nero */
    color: #000 !important; /* Assicurati che il testo sia nero */
}

input.form-control:focus, textarea.form-control:focus, select.form-control:focus {
    border-color: #000 !important; /* Forza il bordo nero anche quando è in focus */
    box-shadow: none !important; /* Rimuovi eventuali ombre predefinite */
}


    </style>
</head>
<body>

    <div class="container mt-5 text-white-custom">
        <div class="form-container text-center">
            <h1 class="mb-4">Completa il tuo ordine</h1>

            <form id="orderForm" onsubmit="return false;">
                <!-- Step 1: Scelta tra Delivery o Asporto -->
                <div class="step active">
                    <h2 class="mb-4">Modalità di consegna</h2>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deliveryType" value="Delivery" id="delivery" required>
                        <label class="form-check-label" for="delivery">Delivery</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deliveryType" value="Asporto" id="asporto" required>
                        <label class="form-check-label" for="asporto">Asporto</label>
                    </div>
                </div>

                <!-- Step 2: Nome, Cognome, Indirizzo, Telefono, Email -->
                <div class="step">
                    <h2 class="mb-4">Informazioni personali</h2>
                    <div class="form-group">
                        <label for="name">Nome:</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="surname">Cognome:</label>
                        <input type="text" class="form-control" id="surname" name="surname" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Indirizzo:</label>
                        <input type="text" class="form-control" id="address" name="address" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Numero di telefono:</label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                </div>

                <!-- Step 3: Orario di consegna -->
                <div class="step">
                    <h2 class="mb-4">Orario di consegna</h2>
                    <div class="form-group">
                        <label for="time">Orario preferito:</label>
                        <select class="form-control" id="time" name="time" required>
                            <option value="" disabled selected>Seleziona un orario</option>
                            <!-- Orari a partire dalle 19:30 con intervalli di 15 minuti -->
                            <script>
                                const select = document.getElementById("time");
                                let start = 19 * 60 + 30; // 19:30 in minuti
                                const end = 23 * 60; // 23:00 in minuti
                                for (let i = start; i <= end; i += 15) {
                                    const hours = Math.floor(i / 60);
                                    const minutes = i % 60;
                                    const time = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                    const option = document.createElement("option");
                                    option.value = time;
                                    option.textContent = time;
                                    select.appendChild(option);
                                }
                            </script>
                        </select>
                    </div>
                </div>
                <!-- Step 4: Riepilogo dell'ordine e riepilogo delle informazioni inserite -->
                <div class="step">

                    
                    <!-- Card Riepilogo Ordine -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h4>Riepilogo Ordine</h4>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped" id="riepilogoOrdineTable">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Quantità</th>
                                        <th>Subtotale</th>
                                    </tr>
                                </thead>
                                <tbody id="ordineTableBody">
                                    <tr>
                                        <td colspan="3" id="ordineVuoto">Caricamento dei dettagli dell'ordine...</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p><strong>Totale:</strong> <span id="riepilogoTotale">€0.00</span></p>
                        </div>
                    </div>

                    <!-- Card Riepilogo Informazioni -->
                    <div class="card">
                        <div class="card-header">
                            <h4>Riepilogo Informazioni</h4>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <tbody id="riepilogoInfoTable">
                                    <tr>
                                        <th>Modalità di consegna</th>
                                        <td id="summaryDelivery"></td>
                                    </tr>
                                    <tr>
                                        <th>Nome e Cognome</th>
                                        <td id="summaryName"></td>
                                    </tr>
                                    <tr>
                                        <th>Indirizzo</th>
                                        <td id="summaryAddress"></td>
                                    </tr>
                                    <tr>
                                        <th>Numero di telefono</th>
                                        <td id="summaryPhone"></td>
                                    </tr>
                                    <tr>
                                        <th>Email</th>
                                        <td id="summaryEmail"></td>
                                    </tr>
                                    <tr>
                                        <th>Orario</th>
                                        <td id="summaryTime"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-group mt-4">
                        <label for="notes">Note varie:</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>

                <div class="buttons text-center">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="nextPrev(-1)" style="display:none;">Indietro</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextPrev(1)">Avanti</button>
                </div>
            </form>

        </div>
    </div>

    <script>
        let currentStep = 0; 
        showStep(currentStep);

        function showStep(n) {
            const steps = document.getElementsByClassName("step");
            steps[n].classList.add("active");

            document.getElementById("prevBtn").style.display = n == 0 ? "none" : "inline-block";
            document.getElementById("nextBtn").innerHTML = n == (steps.length - 1) ? "Conferma Ordine" : "Avanti";
        }

        function nextPrev(n) {
            const steps = document.getElementsByClassName("step");

            if (n === 1 && !validateStep()) {
                return false;
            }

            steps[currentStep].classList.remove("active");

            currentStep += n;

            // Se siamo all'ultimo step, chiama la funzione riepilogo
            if (currentStep >= steps.length - 1) {
                updateSummary(); // Aggiorna il riepilogo con i dati inseriti
                currentStep = steps.length - 1; // Assicurati di restare nell'ultimo step

                // Chiama la funzione riepilogo per ottenere i dati dell'ordine
                riepilogo();

                
                // Chiama la funzione ordina per confermare l'ordine quando l'utente clicca su "Conferma Ordine"
                document.getElementById("nextBtn").addEventListener("click", function() {
                    ordina(); // Invia l'ordine quando si conferma
                });


                showStep(currentStep);
                return;
            }

            showStep(currentStep);
        }

        function validateStep() {
            const steps = document.getElementsByClassName("step");
            const inputs = steps[currentStep].querySelectorAll("input, select");
            let valid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    input.classList.add("is-invalid");
                    valid = false;
                } else {
                    input.classList.remove("is-invalid");
                }
            });

            return valid;
        }

        function updateSummary() {
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked');
            document.getElementById("summaryDelivery").textContent = deliveryType ? deliveryType.value : '';
            document.getElementById("summaryName").textContent = document.getElementById("name").value + " " + document.getElementById("surname").value;
            document.getElementById("summaryAddress").textContent = document.getElementById("address").value;
            document.getElementById("summaryPhone").textContent = document.getElementById("phone").value;
            document.getElementById("summaryEmail").textContent = document.getElementById("email").value;
            document.getElementById("summaryTime").textContent = document.getElementById("time").value;
        }

        function riepilogo() {
            $.ajax({
                type: "POST",
                url: 'action.php?_action=riepilogo',
                dataType: 'json',
                success: function (result) {
                    if (result.status === 1) {
                        const ordineTableBody = $("#ordineTableBody");
                        ordineTableBody.empty();
                        
                        result.data.prodotti.forEach(prodotto => {
                            const prodottoRow = `
                                <tr>
                                    <td>${prodotto.nomeProdotto}</td>
                                    <td>${prodotto.quantita}</td>
                                    <td>€${prodotto.subtotale.toFixed(2)}</td>
                                </tr>
                            `;
                            ordineTableBody.append(prodottoRow);
                        });

                        $("#riepilogoTotale").text(`€${result.data.totale.toFixed(2)}`);

                    } else {
                        alert("Errore durante il caricamento del riepilogo.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Errore nella richiesta AJAX:", status, error);
                    alert("Si è verificato un errore. Riprova più tardi.");
                }
            });
        }



        function ordina() {
        // Recupera i dati dell'utente dal form
        const nome = $('#name').val();
        const cognome = $('#surname').val();
        const indirizzo = $('#address').val();
        const telefono = $('#phone').val();
        const email = $('#email').val();
        const orarioConsegna = $('#time').val();
        const note = $('#notes').val();
        const deliveryType = $('input[name="deliveryType"]:checked').val();

        // Invia la richiesta AJAX con i dati dell'utente
        $.ajax({
            type: "POST",
            url: 'action.php?_action=ordina',
            dataType: 'json',
            data: {
                nome: nome,
                cognome: cognome,
                indirizzo: indirizzo,
                telefono: telefono,
                email: email,
                orarioConsegna: orarioConsegna,
                note: note,
                deliveryType: deliveryType
            },
            success: function(result) {
                if (result.status === 1) {
                    alert("Ordine completato con successo! Totale: €" + result.data.totale.toFixed(2));

                    // Reindirizza alla pagina di conferma/conclusione
                    window.location.href = 'conclusione.html';
                } else {
                    console.error("Errore nell'elaborazione dell'ordine:", result.message);
                    alert("Si è verificato un errore. Riprova più tardi.");
                }
            },
            error: function(xhr, status, error) {
                console.error("Errore nella richiesta AJAX:", error);
                let errorMessage = "Si è verificato un errore di comunicazione con il server.";
                if (xhr.responseText.startsWith("<br />") || xhr.responseText.startsWith("<b>")) {
                    errorMessage += " Il server ha generato un errore PHP.";
                }
                alert(errorMessage + " Riprova più tardi.");
            }
        });
    }

    </script>

    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
